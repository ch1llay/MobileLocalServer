# Mobile Local File Server

Локальный HTTP-сервер для приёма файлов по Wi-Fi. Предназначен для запуска в Termux на телефоне: включаете точку доступа, запускаете сервер — с ноутбука или другого устройства в той же сети можно открыть страницу, ввести **PIN** (выдаёт администратор) и **имя**, затем загружать файлы. Администратор входит по **паролю** в панель `/admin`, создаёт пользователей (им выдаётся 6-значный PIN для загрузки) и просматривает/скачивает загруженные файлы. На каждого отправителя (папку) действует квота 15 GB.

## Требования

- Python 3.10+
- Termux (на Android) или любой другой хост в локальной сети

## Установка в Termux

```bash
pkg update && pkg install python
git clone https://github.com/YOUR_USER/MobileLocalServer.git
cd MobileLocalServer
pip install -r requirements.txt
```

## Настройка

1. Скопируйте пример конфигурации и отредактируйте:

   ```bash
   cp env.example .env
   ```

2. Сгенерируйте хэш пароля администратора (подставьте свой пароль, например `password1234`):

   ```bash
   python scripts/generate_pin_hash.py password1234
   ```

3. Добавьте выведенные `PIN_HASH` и `PIN_SALT` в `.env`. Пример `.env`:

   ```
   UPLOAD_DIR=./uploads
   PORT=8080
   SECRET_KEY=замените-на-длинную-случайную-строку
   TOKEN_MAX_AGE=86400
   MAX_UPLOAD_MB=500
   USER_QUOTA_GB=15
   CODES_FILE=./data/upload_codes.json
   PIN_HASH=<результат generate_pin_hash>
   PIN_SALT=<результат generate_pin_hash>
   ```

4. В Termux для сохранения файлов в папку «Загрузки» можно указать:

   ```
   UPLOAD_DIR=/data/data/com.termux/files/home/storage/downloads/Received
   ```

   Предварительно выполните `termux-setup-storage`, чтобы разрешить доступ к хранилищу.

## Запуск

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8080
```

Или используйте скрипт (порт берётся из переменной окружения `PORT` или 8080):

```bash
chmod +x run.sh
./run.sh
```

Сервер будет доступен по адресу `http://<IP_телефона>:8080`.

## Как узнать IP телефона

- В Termux: `ip addr` (интерфейс `wlan0` при раздаче Wi-Fi).
- В настройках точки доступа на Android часто показывается IP раздающего устройства.

Подключите ноутбук/ПК к этой точке доступа и откройте в браузере `http://<IP>:8080`.

- **Главная (/)** — загрузка файлов: введите **PIN** (получите у администратора; можно продиктовать словами), **ваше имя** и выберите файлы. Список файлов на главной не показывается (только загрузка).
- **Админ-панель (/admin)** — вход по **паролю администратора**. После входа: создание пользователей (генерируется 6-значный PIN, показывается один раз — передайте его пользователю), список выданных PIN, список загруженных файлов и скачивание.

Квота на папку отправителя: по умолчанию 15 GB (`USER_QUOTA_GB` в `.env`).

## Безопасность

- Доступ только по локальной сети (сервер слушает `0.0.0.0`, без проброса портов из интернета).
- Пароль администратора хранится в виде хэша (PBKDF2-HMAC-SHA256); после ввода пароля выдаётся подписанный токен (срок жизни по умолчанию 24 часа).
- PIN для загрузки хранятся только в виде SHA-256 хэша в файле `CODES_FILE`; при создании пользователя PIN показывается один раз.
- Загрузка возможна только при валидном PIN; квота 15 GB на папку (на отправителя) проверяется на сервере.
- Список файлов и скачивание — только по токену администратора (Bearer или `?token=...`).
- Загрузки ограничены по размеру одного файла (`MAX_UPLOAD_MB`), пути проверяются (запрет path traversal).

## API

- `POST /api/login` — тело `{"password": "..."}` (пароль администратора); ответ `{"token": "..."}`.
- `GET /api/files` — список файлов (заголовок `Authorization: Bearer <token>`).
- `GET /api/files/{path}` — скачивание файла; токен в заголовке или `?token=...`.
- `POST /api/upload` — multipart: поля `pin`, `sender`, `file`; без токена (доступ по PIN).
- `POST /api/admin/users` — тело `{"label": "..."}` (опционально); заголовок `Authorization: Bearer <token>`; ответ `{"pin": "...", "label": "...", "created_at": "..."}` (PIN показывается один раз).
- `GET /api/admin/users` — список пользователей (label, created_at); заголовок `Authorization: Bearer <token>`.
